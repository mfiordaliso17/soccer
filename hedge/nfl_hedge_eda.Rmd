---
title: "Hedge Strategy"
author: "Markus Fiordaliso"
date: "10/13/2020"
output: pdf_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(warning = F)
```


# Data

```{r include=F}
# package
library(tidyverse)
library(scales)
library(VIM)
library(lubridate)
library(gridExtra)
```


```{r include=F}
odds_df <- read.csv("/Users/markusfiordaliso/Documents/R/sports_bet/hedge/hedge_data/nfl_20100701_20201012_ml.csv") %>% 
  select(-odds_URL)

```

## Missing Data


Bovada seems to be missing the most data. I will leverage Pinnacle due the legitimacy of the book, coupled with the relatively low levels of missing data.

Some scores are missing. After doing some research on a few of these instances, it looks like sportsbookreview is missing these scores even though the game took place. This can be expected to some degree since I didn't pay for the data. I will factor these out of the analysis
```{r}


missing <- map_df(odds_df, ~sum(is.na(.))) %>% 
  select_if(~any(. > 0))

aggr(odds_df[ , colnames(odds_df) %in% colnames(missing)],
     sortVars = T,
     cex.axis = 0.4,
     oma = c(4,2,1,1))
                           
# remove missing scores from df

odds_df <- odds_df %>% 
  filter(!is.na(away_4Q))
```


## Tidy

```{r}
source("/Users/markusfiordaliso/Documents/R/sports_bet/odds_functions.R")

odds_df <- odds_manipulate_fn(odds_df)

# using pinnacle as the book
sports_book <- "pinnacle"

# filter out missing odds
odds_df <- odds_df %>% 
  filter(!is.na(pinnacle1), !is.na(pinnacle2))

odds_df <- odds_book_remove_fn(odds_df, sports_book)
```


# EDA


## Odds

Exploring the frequency each odd occurs, as this will give me a better feel on how often I can execute strategies that might target specific odd thresholds. -200:200 is the most frequent odds, which is what I would expect.
```{r}

odds_df <- fav_und_odd_score_fn(odds_df, sports_book)

fav_odd_dist <- odds_df %>% 
  ggplot(aes(x = fav_odd)) +
  geom_histogram(binwidth = 100,
                 aes(y = stat(count) / sum(count)),
                 color = "black",
                 fill = "purple",
                 closed = "right",
                 boundary = 0) +
  scale_x_continuous(breaks = seq(-1000, 0, by = 100)) +
  coord_cartesian(xlim = c(-1000, 0),
                  ylim = c(0, 0.6)) +
  labs(y = "Frequency",
       title = "NFL Favorite Odds Frequency",
       caption = "Excluded odds exceeding -1000")

und_odd_dist <- odds_df %>% 
  ggplot(aes(x = und_odd)) +
  geom_histogram(binwidth = 100,
                 aes(y = stat(count) / sum(count)),
                 color = "black",
                 fill = "light blue",
                 closed = "left",
                 boundary = 0) +
  scale_x_continuous(breaks = seq(-100, 1000, by = 100)) +
  coord_cartesian(xlim = c(-200, 1000),
                  ylim = c(0, 0.6)) +
  labs(y = "Frequency",
       title = "NFL Underdog Odds Frequency",
       caption = "Excluded odds exceeding +1000")

grid.arrange(fav_odd_dist, und_odd_dist, nrow = 1)
```
Explore spread

```{r}

odds_df <- odds_df %>% 
  mutate(book_spread = abs(ifelse(und_odd > 0, fav_odd + und_odd, fav_odd + 100 + und_odd + 100)) / 100)

book_spead_view <- odds_df %>% 
  ggplot(aes(x = book_spread)) +
  geom_histogram(aes(y = stat(count) / sum(count)),
                 binwidth = 0.05,
                 boundary = 0,
                 closed = "left",
                 color = "black",
                 fill = "purple") +
  coord_cartesian(xlim = c(0, 1),
                  ylim = c(0, 0.3)) +
  scale_x_continuous(breaks = seq(0, 1, 0.05)) +
  labs(y = "Frequency",
       title = "Sports Book Spread per $1",
       caption = "Spread calculates the house difference on betting on both the underdog and favorite")
  

spread_odd_view <- odds_df %>% 
  ggplot(aes(y = und_odd, x = book_spread)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Book Spread vs Odds Relationship")


grid.arrange(book_spead_view, )
```

